# File: mtca_crate.db
# Date: 2017-06-16
# Author: Wayne Lewis
#
# Description:
# Database for holding cratewide information
#

record(bo, "$(P)SensorScan-Cmd") {
    field(DESC, "Master record for scanning values")
    field(DTYP, "Python Device")
    field(SCAN, "5 second")
    field(OUT,  "@MTCACrate read_sensors")

    info(autosaveFields, "SCAN")
}

record(stringout, "$(P)Hostname-Cte") {
    field(DESC, "Crate host name")
    field(DTYP, "Python Device")
    field(PINI, "YES")
    field(OUT,  "@MTCACrate set_host")
    field(VAL,  "$(MCH_HOST)")
    field(FLNK, "$(P)Username-Cte")

    info(autosaveFields, "VAL")
}

record(stringout, "$(P)Username-Cte") {
    field(DESC, "Crate user name")
    field(DTYP, "Python Device")
    field(OUT,  "@MTCACrate set_user")
    field(FLNK, "$(P)Password-Cte")

    info(autosaveFields, "VAL")
}

# This may be able to move to an environment variable on the crate
record(stringout, "$(P)Password-Cte") {
    field(DESC, "Crate password")
    field(DTYP, "Python Device")
    field(OUT,  "@MTCACrate set_password")
    field(FLNK, "$(P)ReadFRUList-Cmd")

    info(autosaveFields, "VAL")
}

record(bo, "$(P)ReadFRUList-Cmd") {
    field(DESC, "Get crate FRU list")
    field(DTYP, "Python Device")
    field(OUT,  "@MTCACrate get_fru_list")
    field(SCAN, "Passive")

    info(autosaveFields, "SCAN")
}

record(bo, "$(P)Reset-Cmd") {
    field(DESC, "Reset crate")
    field(DTYP, "Python Device")
    field(OUT,  "@MTCACrate crate_reset")
    field(SCAN, "Passive")
}

record(stringin, "$(P)CrateID-Cte") {
    field(DESC, "Crate ID")
    field(VAL,  "$(CRATE_ID)")
    field(PINI, "YES")
}

record(stringin, "$(P)RackID-Cte") {
    field(DESC, "Rack ID")
    field(VAL,  "$(RACK_ID)")
    field(PINI, "YES")
}

# Calculate fan speed averages
record(calcout, "$(P)FanFrontAvg-Calc") {
    field(DESC, "Front fan average calculation")
    field(INPA, "$(P)$(CU1=CU01)FanFrontAvg-Mon CPP")
    field(INPB, "$(P)$(CU2=CU02)FanFrontAvg-Mon CPP")
    field(CALC, "(A+B)/2")
    field(OOPT, "On Change")
    field(DOPT, "Use CALC")
    field(OUT,  "$(P)FanFrontAvg-Mon PP")
    field(PINI, "NO")
}

record(ai, "$(P)FanFrontAvg-Mon") {
    field(DESC, "Front fan average")
    field(EGU,  "RPM")
    field(PREC, "0")
    field(LOLO, "500")
    field(LOW,  "1000")
    field(HIGH, "3500")
    field(HIHI, "4000")
    field(LLSV, "MAJOR")
    field(LSV,  "MINOR")
    field(HSV,  "MINOR")
    field(HHSV, "MAJOR")
}

record(calcout, "$(P)FanRearAvg-Calc") {
    field(DESC, "Rear fan average calculation")
    field(INPA, "$(P)$(CU1=CU01)FanRearAvg-Mon CPP")
    field(INPB, "$(P)$(CU2=CU02)FanRearAvg-Mon CPP")
    field(CALC, "(A+B)/2")
    field(OOPT, "On Change")
    field(DOPT, "Use CALC")
    field(OUT,  "$(P)FanRearAvg-Mon PP")
    field(PINI, "NO")
}

record(ai, "$(P)FanRearAvg-Mon") {
    field(DESC, "Rear fan average")
    field(EGU,  "RPM")
    field(PREC, "0")
    field(LOLO, "500")
    field(LOW,  "1000")
    field(HIGH, "3500")
    field(HIHI, "4000")
    field(LLSV, "MAJOR")
    field(LSV,  "MINOR")
    field(HSV,  "MINOR")
    field(HHSV, "MAJOR")
}

record(calcout, "$(P)FanAvg-Calc") {
    field(DESC, "Crate fan average calculation")
    field(INPA, "$(P)$(CU1=CU01)FanAvg-Mon CPP")
    field(INPB, "$(P)$(CU2=CU02)FanAvg-Mon CPP")
    field(CALC, "(A+B)/2")
    field(OOPT, "On Change")
    field(DOPT, "Use CALC")
    field(OUT,  "$(P)FanAvg-Mon PP")
    field(PINI, "NO")
}

record(ai, "$(P)FanAvg-Mon") {
    field(DESC, "Crate fan average")
    field(EGU,  "RPM")
    field(PREC, "0")
    field(LOLO, "500")
    field(LOW,  "1000")
    field(HIGH, "3500")
    field(HIHI, "4000")
    field(LLSV, "MAJOR")
    field(LSV,  "MINOR")
    field(HSV,  "MINOR")
    field(HHSV, "MAJOR")
}

# Calculate the average inlet temperature
record(calcout, "$(P)TempInletAvg-Calc") {
    field(DESC, "Crate average inlet temp calc")
    field(INPA, "$(P)PM02TempInlet-Mon CPP")
    field(INPB, "$(P)CU02Temp1-Mon CPP")
    field(INPC, "$(P)CU02Temp2-Mon CPP")
    field(INPD, "$(P)CU01Temp1-Mon CPP")
    field(INPE, "$(P)CU01Temp2-Mon CPP")
    field(CALC, "(A-4+B+C+D+E-1.5)/5")
    field(OOPT, "On Change")
    field(DOPT, "Use CALC")
    field(OUT,  "$(P)TempInletAvg-Mon PP")
    field(PINI, "YES")
}

record(ai, "$(P)TempInletAvg-Mon") {
    field(DESC, "Crate average inlet temp")
    field(EGU,  "C")
    field(PREC, "1")
}


